<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Semoga Bisa</title>

  <!-- A-Frame dan AR.js (NFT / image tracking) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar-nft.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #infoButton {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      display: none;
      z-index: 9999;
    }

    #infoPopup {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 320px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 16px;
      display: none;
      z-index: 9999;
      text-align: center;
      color: #333;
    }

    #closeInfo {
      background: #444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin-top: 10px;
      cursor: pointer;
    }

    #closeInfo:hover {
      background: #222;
    }

    #menu {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      padding: 8px 10px;
      display: none;
      z-index: 9999;
    }

    #menu button {
      display: block;
      background: #f0c000;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      margin: 4px 0;
      cursor: pointer;
      font-weight: bold;
    }

    #menu button:hover {
      background: #e5b200;
    }
  </style>

  <script>
    // === Gesture Detector ===
    AFRAME.registerComponent("gesture-detector", {
      init: function () {
        this.internalState = { previousState: null };
        const canvas = this.el.sceneEl.canvas;
        canvas.addEventListener("touchstart", (e) => this.onTouchStart(e));
        canvas.addEventListener("touchmove", (e) => this.onTouchMove(e));
        canvas.addEventListener("touchend", () => this.onTouchEnd());
      },
      onTouchStart(e) {
        if (e.touches.length === 1) {
          this.internalState.previousState = {
            x: e.touches[0].clientX,
            y: e.touches[0].clientY,
          };
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          this.internalState.previousState = {
            pinchDistance: Math.sqrt(dx * dx + dy * dy),
          };
        }
      },
      onTouchMove(e) {
        const prev = this.internalState.previousState;
        if (!prev) return;
        if (e.touches.length === 1) {
          const dx = e.touches[0].clientX - prev.x;
          const dy = e.touches[0].clientY - prev.y;
          this.el.emit("gesture-drag", { deltaX: dx, deltaY: dy });
          this.internalState.previousState = {
            x: e.touches[0].clientX,
            y: e.touches[0].clientY,
          };
        } else if (e.touches.length === 2 && prev.pinchDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleChange = distance / prev.pinchDistance;
          this.el.emit("gesture-pinch", { scaleChange });
          this.internalState.previousState.pinchDistance = distance;
        }
      },
      onTouchEnd() {
        this.internalState.previousState = null;
      },
    });

    // === Gesture Handler ===
    AFRAME.registerComponent("gesture-handler", {
      schema: { enabled: { default: true } },
      init: function () {
        this.scaleFactor = 1;
        this.rotation = { x: 0, y: 0 };
        this.handlePinch = this.handlePinch.bind(this);
        this.handleDrag = this.handleDrag.bind(this);
        this.el.sceneEl.addEventListener("gesture-pinch", this.handlePinch);
        this.el.sceneEl.addEventListener("gesture-drag", this.handleDrag);
      },
      remove: function () {
        this.el.sceneEl.removeEventListener("gesture-pinch", this.handlePinch);
        this.el.sceneEl.removeEventListener("gesture-drag", this.handleDrag);
      },
      handlePinch: function (e) {
        if (!this.data.enabled) return;
        this.scaleFactor *= e.detail.scaleChange;
        this.scaleFactor = Math.min(Math.max(this.scaleFactor, 0.05), 5);
        this.el.object3D.scale.set(
          this.scaleFactor,
          this.scaleFactor,
          this.scaleFactor
        );
      },
      handleDrag: function (e) {
        if (!this.data.enabled) return;
        this.rotation.y += e.detail.deltaX * 0.5;
        this.rotation.x += e.detail.deltaY * 0.5;
        this.rotation.x = Math.max(Math.min(this.rotation.x, 90), -90);
        this.el.object3D.rotation.set(
          THREE.MathUtils.degToRad(this.rotation.x),
          THREE.MathUtils.degToRad(this.rotation.y),
          0
        );
      },
    });

    // === Marker Events + Menu ===
    window.addEventListener("DOMContentLoaded", () => {
      const marker = document.querySelector("a-nft");
      const infoButton = document.getElementById("infoButton");
      const infoPopup = document.getElementById("infoPopup");
      const closeInfo = document.getElementById("closeInfo");
      const menu = document.getElementById("menu");

      marker.addEventListener("markerFound", () => {
        infoButton.style.display = "block";
        menu.style.display = "block";
      });

      marker.addEventListener("markerLost", () => {
        infoButton.style.display = "none";
        infoPopup.style.display = "none";
        menu.style.display = "none";
      });

      infoButton.addEventListener("click", () => {
        infoPopup.style.display = "block";
      });

      closeInfo.addEventListener("click", () => {
        infoPopup.style.display = "none";
      });
    });

    function showModel(selectedId) {
      const models = ["keris1", "keris2", "keris3"];
      models.forEach(id => {
        const el = document.getElementById(id);
        el.setAttribute("visible", id === selectedId);
      });
    }
  </script>
</head>

<body>
  <button id="infoButton">ℹ️ Info</button>

  <div id="infoPopup">
    <h3>Koleksi Keris Nusantara</h3>
    <p>Pilih salah satu koleksi keris untuk melihat detail bentuk dan hiasannya.<br>
    Geser untuk memutar dan cubit untuk memperbesar.</p>
    <button id="closeInfo">Tutup</button>
  </div>

  <div id="menu">
    <button onclick="showModel('keris1')">Keris 1</button>
    <button onclick="showModel('keris2')">Keris 2</button>
    <button onclick="showModel('keris3')">Keris 3</button>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    gesture-detector
  >
    <!-- Gunakan marker gambar (bukan pattern) -->
    <a-nft
      type="nft"
      url="assets/marker"  
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5"
    >
      <a-entity id="keris1"
                crossorigin="anonymous"
                gltf-model="simple_keris.glb"
                scale="0.1 0.1 0.1"
                position="0 0 0"
                rotation="90 90 0"
                visible="true"
                gesture-handler></a-entity>

      <a-entity id="keris2"
                crossorigin="anonymous"
                gltf-model="red_skull_keris.glb"
                scale="0.1 0.1 0.1"
                position="0 0 0"
                rotation="90 90 0"
                visible="false"
                gesture-handler></a-entity>

      <a-entity id="keris3"
                crossorigin="anonymous"
                gltf-model="dark_keris.glb"
                scale="0.1 0.1 0.1"
                position="0 0 0"
                rotation="90 90 0"
                visible="false"
                gesture-handler></a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
