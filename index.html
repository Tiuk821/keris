<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebAR Keris Interaktif + Info</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    /* Tombol Info */
    #infoButton {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      display: none; /* hanya muncul jika marker terlihat */
      z-index: 9999;
    }

    /* Popup Info */
    #infoPopup {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 300px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 16px;
      display: none;
      z-index: 9999;
      text-align: center;
      color: #333;
    }

    #closeInfo {
      background: #444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin-top: 10px;
      cursor: pointer;
    }

    #closeInfo:hover {
      background: #222;
    }
  </style>

  <script>
    // ==== Gesture Detector ====
    AFRAME.registerComponent("gesture-detector", {
      init: function () {
        this.internalState = { previousState: null };
        const canvas = this.el.sceneEl.canvas;

        canvas.addEventListener("touchstart", (e) => this.onTouchStart(e));
        canvas.addEventListener("touchmove", (e) => this.onTouchMove(e));
        canvas.addEventListener("touchend", () => this.onTouchEnd());
      },
      onTouchStart(e) {
        if (e.touches.length === 1) {
          this.internalState.previousState = {
            x: e.touches[0].clientX,
            y: e.touches[0].clientY,
          };
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          this.internalState.previousState = {
            pinchDistance: Math.sqrt(dx * dx + dy * dy),
          };
        }
      },
      onTouchMove(e) {
        const prev = this.internalState.previousState;
        if (!prev) return;

        if (e.touches.length === 1) {
          const dx = e.touches[0].clientX - prev.x;
          const dy = e.touches[0].clientY - prev.y;
          this.el.emit("gesture-drag", { deltaX: dx, deltaY: dy });
          this.internalState.previousState = {
            x: e.touches[0].clientX,
            y: e.touches[0].clientY,
          };
        } else if (e.touches.length === 2 && prev.pinchDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleChange = distance / prev.pinchDistance;
          this.el.emit("gesture-pinch", { scaleChange });
          this.internalState.previousState.pinchDistance = distance;
        }
      },
      onTouchEnd() {
        this.internalState.previousState = null;
      },
    });

    // ==== Gesture Handler ====
    AFRAME.registerComponent("gesture-handler", {
      schema: { enabled: { default: true } },
      init: function () {
        this.scaleFactor = 1;
        this.rotation = { x: 0, y: 0 };

        this.handlePinch = this.handlePinch.bind(this);
        this.handleDrag = this.handleDrag.bind(this);

        this.el.sceneEl.addEventListener("gesture-pinch", this.handlePinch);
        this.el.sceneEl.addEventListener("gesture-drag", this.handleDrag);
      },
      remove: function () {
        this.el.sceneEl.removeEventListener("gesture-pinch", this.handlePinch);
        this.el.sceneEl.removeEventListener("gesture-drag", this.handleDrag);
      },
      handlePinch: function (e) {
        if (!this.data.enabled) return;
        this.scaleFactor *= e.detail.scaleChange;
        this.scaleFactor = Math.min(Math.max(this.scaleFactor, 0.05), 5);
        this.el.object3D.scale.set(
          this.scaleFactor,
          this.scaleFactor,
          this.scaleFactor
        );
      },
      handleDrag: function (e) {
        if (!this.data.enabled) return;
        this.rotation.y += e.detail.deltaX * 0.5;
        this.rotation.x += e.detail.deltaY * 0.5;
        this.rotation.x = Math.max(Math.min(this.rotation.x, 90), -90);

        this.el.object3D.rotation.set(
          THREE.MathUtils.degToRad(this.rotation.x),
          THREE.MathUtils.degToRad(this.rotation.y),
          0
        );
      },
    });

    // ==== Event Marker ====
    window.addEventListener("DOMContentLoaded", () => {
      const marker = document.querySelector("a-marker");
      const infoButton = document.getElementById("infoButton");
      const infoPopup = document.getElementById("infoPopup");
      const closeInfo = document.getElementById("closeInfo");

      marker.addEventListener("markerFound", () => {
        infoButton.style.display = "block";
      });

      marker.addEventListener("markerLost", () => {
        infoButton.style.display = "none";
        infoPopup.style.display = "none";
      });

      infoButton.addEventListener("click", () => {
        infoPopup.style.display = "block";
      });

      closeInfo.addEventListener("click", () => {
        infoPopup.style.display = "none";
      });
    });
  </script>
</head>

<body>
  <!-- Tombol Info -->
  <button id="infoButton">ℹ️ Info</button>

  <!-- Popup Info -->
  <div id="infoPopup">
    <h3>Keris Nusantara</h3>
    <p>
      Keris adalah senjata tradisional Indonesia yang memiliki nilai sejarah,
      budaya, dan spiritual. Biasanya digunakan sebagai simbol keberanian dan
      kehormatan.
    </p>
    <button id="closeInfo">Tutup</button>
  </div>

  <!-- Scene AR -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    gesture-detector
  >
    <a-marker type="pattern" url="pattern-marker.patt">
      <a-entity
        id="keris"
        gltf-model="simple_keris (1).glb"
        scale="0.1 0.1 0.1"
        position="0 0.5 0"
        rotation="90 90 0"
        gesture-handler
      ></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
