<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR Keris Interaktif 4</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar.min.js"></script>

    <script>
      // ====== Gesture Detector (mendeteksi pinch dan drag) ======
      AFRAME.registerComponent('gesture-detector', {
        init: function () {
          this.internalState = { previousState: null };
          const canvas = this.el.sceneEl.canvas;

          canvas.addEventListener('touchstart', e => this.onTouchStart(e));
          canvas.addEventListener('touchmove', e => this.onTouchMove(e));
          canvas.addEventListener('touchend', () => this.onTouchEnd());
        },
        onTouchStart(e) {
          if (e.touches.length === 1) {
            this.internalState.previousState = {
              x: e.touches[0].clientX,
              y: e.touches[0].clientY
            };
          } else if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            this.internalState.previousState = { pinchDistance: Math.sqrt(dx * dx + dy * dy) };
          }
        },
        onTouchMove(e) {
          const prev = this.internalState.previousState;
          if (!prev) return;

          if (e.touches.length === 1) {
            const dx = e.touches[0].clientX - prev.x;
            const dy = e.touches[0].clientY - prev.y;
            this.el.emit('gesture-drag', { deltaX: dx, deltaY: dy });
            this.internalState.previousState = {
              x: e.touches[0].clientX,
              y: e.touches[0].clientY
            };
          } else if (e.touches.length === 2 && prev.pinchDistance) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const scaleChange = distance / prev.pinchDistance;
            this.el.emit('gesture-pinch', { scaleChange });
            this.internalState.previousState.pinchDistance = distance;
          }
        },
        onTouchEnd() {
          this.internalState.previousState = null;
        }
      });

      // ====== Gesture Handler (mengatur rotasi dan zoom model) ======
      AFRAME.registerComponent('gesture-handler', {
        schema: { enabled: { default: true } },
        init: function () {
          this.scaleFactor = 1;
          this.rotation = { x: 0, y: 0 };

          this.handlePinch = this.handlePinch.bind(this);
          this.handleDrag = this.handleDrag.bind(this);

          this.el.sceneEl.addEventListener('gesture-pinch', this.handlePinch);
          this.el.sceneEl.addEventListener('gesture-drag', this.handleDrag);
        },
        remove: function () {
          this.el.sceneEl.removeEventListener('gesture-pinch', this.handlePinch);
          this.el.sceneEl.removeEventListener('gesture-drag', this.handleDrag);
        },
        handlePinch: function (e) {
          if (!this.data.enabled) return;
          this.scaleFactor *= e.detail.scaleChange;
          this.scaleFactor = Math.min(Math.max(this.scaleFactor, 0.05), 5);
          this.el.object3D.scale.set(this.scaleFactor, this.scaleFactor, this.scaleFactor);
        },
        handleDrag: function (e) {
          if (!this.data.enabled) return;

          // Geser horizontal untuk rotasi Y
          this.rotation.y += e.detail.deltaX * 0.5;

          // Geser vertikal untuk rotasi X
          this.rotation.x += e.detail.deltaY * 0.5;

          // Batasi agar tidak berputar terlalu ekstrem
          this.rotation.x = Math.max(Math.min(this.rotation.x, 90), -90);

          // Terapkan rotasi
          this.el.object3D.rotation.set(
            THREE.MathUtils.degToRad(this.rotation.x),
            THREE.MathUtils.degToRad(this.rotation.y),
            0
          );
        }
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      gesture-detector
    >
      <a-marker type="pattern" url="pattern-marker.patt">
        <a-entity
          id="keris"
          gltf-model="simple_keris (1).glb"
          scale="0.1 0.1 0.1"
          position="0 0.5 0"
          rotation="90 90 0"
          gesture-handler
        ></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
